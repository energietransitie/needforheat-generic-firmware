name: Build CI
# Trigger on any change that is not markdown and not in the main branch.
on:
  push:
    branches: [ main ]
    paths-ignore:
      - '*.md'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '*.md'

jobs:
  build:
    runs-on: ubuntu-latest
    concurrency: 
      group: ${{ github.ref }}
      cancel-in-progress: true
    strategy:
      matrix:
        # List all of the PlatformIO platforms to build
        platformio_env:
          - ESP32DEV
          - M5STACK_COREINK

        # List of the examples to build.
        example_dir:
          - examples/presence_detector
   
    steps:
      # Checkout repository.
      - name: Checkout code
        uses: actions/checkout@v2
      
      # Setup Python (needed by PlatformIO)
      - name: Setup Python
        uses: actions/setup-python@v2

      # Setup PlatformIO.
      - name: Setup PlatformIO
        run: pip install platformio
        
      # Change library from github to local directory in platformio.ini.
      - name: Use local library version
        env:
          EXAMPLE_DIR: ${{ matrix.example_dir }}
        run: sed -i 's=https://github.com/energietransitie/twomes-generic-esp-firmware=../../=g' $EXAMPLE_DIR/platformio.ini
      
      # Build the PlatformIO project.
      - name: Build PlatformIO project
        env:
          PLATFORMIO_ENV: ${{ matrix.platformio_env }}
          EXAMPLE_DIR: ${{ matrix.example_dir }}
        run: pio run -e $PLATFORMIO_ENV -d $EXAMPLE_DIR
